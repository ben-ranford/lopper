name: ci

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        if: ${{ !env.ACT }}
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup Go (act)
        if: ${{ env.ACT }}
        run: |
          if ! command -v go >/dev/null 2>&1; then
            apt-get update
            apt-get install -y golang-go
          fi
          go version

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          if [ -z "${ACT:-}" ]; then
            echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          fi

      - name: Run CI target
        run: |
          if [ -n "${ACT:-}" ]; then
            PATH="$(go env GOPATH)/bin:$PATH" make ci
          else
            make ci
          fi

      - name: Run coverage gate
        id: cov
        continue-on-error: true
        env:
          COVERAGE_MIN: 60
        run: |
          set +e
          if [ -n "${ACT:-}" ]; then
            PATH="$(go env GOPATH)/bin:$PATH" make cov COVERAGE_MIN="${COVERAGE_MIN}"
          else
            make cov COVERAGE_MIN="${COVERAGE_MIN}"
          fi
          status=$?
          if [ -f .artifacts/coverage-total.txt ]; then
            total="$(cat .artifacts/coverage-total.txt)"
          else
            total=""
          fi
          echo "total=$total" >> "$GITHUB_OUTPUT"
          exit $status

      - name: Comment on coverage failure
        if: ${{ github.event_name == 'pull_request' && steps.cov.outcome == 'failure' && !env.ACT }}
        uses: actions/github-script@v8
        env:
          COVERAGE_MIN: 60
          COVERAGE_TOTAL: ${{ steps.cov.outputs.total }}
        with:
          script: |
            const marker = '<!-- lopper-coverage-failure -->';
            const total = process.env.COVERAGE_TOTAL || 'unavailable';
            const body = `${marker}
            âŒ Coverage gate failed.

            Required: >= ${process.env.COVERAGE_MIN}%
            Actual: ${total === 'unavailable' ? total : `${total}%`}

            Run \`make cov\` locally for details.`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.type === 'Bot' &&
                typeof comment.body === 'string' &&
                comment.body.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Fail workflow on coverage gate
        if: ${{ steps.cov.outcome == 'failure' }}
        run: exit 1

      - name: Upload binary artifact
        if: ${{ always() && !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: lopper-bin
          path: bin/lopper
          if-no-files-found: ignore

      - name: Mock artifact upload (act)
        if: ${{ always() && env.ACT }}
        run: |
          test -f bin/lopper
          ls -lh bin/lopper
