name: release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '.github/**'
      - 'README.md'
      - 'CONTRIBUTING.md'

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Compute release tag
        id: tag
        run: |
          short_sha="${GITHUB_SHA::7}"
          date_tag="$(date -u +'%Y%m%d%H%M%S')"
          tag="main-${date_tag}-${short_sha}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  build-linux-windows:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup Go (act)
        if: ${{ github.actor == 'nektos/act' }}
        run: |
          if ! command -v go >/dev/null 2>&1; then
            apt-get update
            apt-get install -y golang-go
          fi
          go version

      - name: Setup Zig
        if: ${{ github.actor != 'nektos/act' }}
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Setup Zig (act)
        if: ${{ github.actor == 'nektos/act' }}
        run: |
          if ! command -v zig >/dev/null 2>&1; then
            urls=(
              "https://ziglang.org/download/0.15.2/zig-x86_64-linux-0.15.2.tar.xz"
              "https://pkg.machengine.org/zig/zig-x86_64-linux-0.15.2.tar.xz"
            )
            for url in "${urls[@]}"; do
              echo "Trying $url"
              if curl --fail --location --connect-timeout 20 --max-time 120 -o /tmp/zig.tar.xz "$url"; then
                break
              fi
            done
            test -s /tmp/zig.tar.xz
            rm -rf /opt/zig
            mkdir -p /opt/zig
            tar -xJf /tmp/zig.tar.xz -C /opt/zig --strip-components=1
            ln -sf /opt/zig/zig /usr/local/bin/zig
          fi
          zig version

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          if [ -z "${ACT:-}" ]; then
            echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          fi

      - name: Validate project
        run: |
          if [ -n "${ACT:-}" ]; then
            PATH="$(go env GOPATH)/bin:$PATH" make ci
          else
            make ci
          fi

      - name: Build Linux/Windows release artifacts
        run: |
          make release \
            VERSION=${{ needs.prepare.outputs.tag }} \
            PLATFORMS="linux/amd64 linux/arm64 windows/amd64 windows/arm64"

      - name: Upload Linux/Windows artifacts
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@v6
        with:
          name: release-linux-windows
          path: |
            dist/*.tar.gz
            dist/*.zip

      - name: Mock Linux/Windows artifact upload (act)
        if: ${{ github.actor == 'nektos/act' }}
        run: ls -lh dist/*

  build-darwin:
    if: ${{ github.actor != 'nektos/act' }}
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Validate project
        run: make ci

      - name: Build Darwin release artifact
        run: |
          host_goarch="$(go env GOARCH)"
          make release \
            VERSION=${{ needs.prepare.outputs.tag }} \
            PLATFORMS="darwin/${host_goarch}"

      - name: Upload Darwin artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-darwin
          path: |
            dist/*.tar.gz
            dist/*.zip

  build-darwin-act:
    if: ${{ github.actor == 'nektos/act' }}
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup Go (act)
        if: ${{ github.actor == 'nektos/act' }}
        run: |
          if ! command -v go >/dev/null 2>&1; then
            apt-get update
            apt-get install -y golang-go
          fi
          go version

      - name: Build Darwin release artifact (act mock)
        run: |
          mkdir -p dist
          mock_dir="dist/lopper_${{ needs.prepare.outputs.tag }}_darwin_amd64"
          mkdir -p "$mock_dir"
          cp README.md "$mock_dir/README.md"
          tar -czf "${mock_dir}.tar.gz" -C dist "$(basename "$mock_dir")"
          rm -rf "$mock_dir"

      - name: Mock Darwin artifact upload (act)
        run: ls -lh dist/*

  build-ghcr:
    if: ${{ github.actor != 'nektos/act' }}
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Compute image name
        id: image
        run: |
          owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          echo "name=ghcr.io/${owner}/lopper" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.image.outputs.name }}:${{ needs.prepare.outputs.tag }}
            ${{ steps.image.outputs.name }}:latest
          provenance: false

  build-ghcr-act:
    if: ${{ github.actor == 'nektos/act' }}
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Compute image name
        id: image
        run: |
          owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          echo "name=ghcr.io/${owner}/lopper" >> "$GITHUB_OUTPUT"

      - name: Mock GHCR build/push (act)
        run: |
          echo "Mock GHCR publish for:"
          echo "${{ steps.image.outputs.name }}:${{ needs.prepare.outputs.tag }}"
          echo "${{ steps.image.outputs.name }}:latest"

  publish:
    if: ${{ github.actor != 'nektos/act' && always() && needs.prepare.result == 'success' && needs.build-linux-windows.result == 'success' && needs.build-darwin.result == 'success' && (needs.build-darwin-act.result == 'success' || needs.build-darwin-act.result == 'skipped') && needs.build-ghcr.result == 'success' && (needs.build-ghcr-act.result == 'success' || needs.build-ghcr-act.result == 'skipped') }}
    needs:
      - prepare
      - build-linux-windows
      - build-darwin
      - build-darwin-act
      - build-ghcr
      - build-ghcr-act
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout (for changelog generation)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download release artifacts
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: dist

      - name: Generate changelog
        run: |
          set -euo pipefail
          current_tag="${{ needs.prepare.outputs.tag }}"
          previous_tag="$(git tag --list 'main-*' --sort=-creatordate | awk -v current="${current_tag}" '$0 != current {print; exit}')"
          ghcr_owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          ghcr_ref="ghcr.io/${ghcr_owner}/lopper:${current_tag}"
          ghcr_package_url="https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lopper"

          {
            echo "## Changelog"
            echo
            echo "## Container image"
            echo
            echo "- Tagged image: \`${ghcr_ref}\`"
            echo "- Package: [GHCR lopper package](${ghcr_package_url})"
            echo "- Pull command: \`docker pull ${ghcr_ref}\`"
            echo
            if [ -n "${previous_tag}" ]; then
              echo "Changes since \`${previous_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${previous_tag}..${GITHUB_SHA}"
            else
              echo "All commits up to \`${current_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${GITHUB_SHA}"
            fi
            echo
            echo
            echo "---"
            echo
            echo "_GitHub auto-generated release notes follow._"
          } > release-changelog.md

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body_path: release-changelog.md
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip

  publish-act:
    if: ${{ github.actor == 'nektos/act' && always() && needs.prepare.result == 'success' && needs.build-linux-windows.result == 'success' && needs.build-darwin-act.result == 'success' && needs.build-ghcr-act.result == 'success' }}
    needs:
      - prepare
      - build-linux-windows
      - build-darwin-act
      - build-ghcr-act
    runs-on: ubuntu-latest
    steps:
      - name: Mock publish summary (act)
        run: |
          echo "Prepared tag: ${{ needs.prepare.outputs.tag }}"
          echo "Linux/Windows and Darwin mock build jobs completed successfully under act."
