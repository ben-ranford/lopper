name: release

on:
  schedule:
    - cron: '0 12 * * 6'
  workflow_dispatch:

concurrency:
  # Serialize release runs so newer commits queue behind in-flight releases.
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      previous_tag: ${{ steps.tag.outputs.previous_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute weekly semver tag
        id: tag
        run: |
          set -euo pipefail
          git fetch --tags --force

          latest_tag="$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-version:refname | head -n1)"
          if [ -z "$latest_tag" ]; then
            next_tag="v0.1.0"
            previous_tag=""
          else
            if [[ "$latest_tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              next_tag="v${major}.${minor}.$((patch + 1))"
              previous_tag="$latest_tag"
            else
              echo "Latest semver tag '$latest_tag' is invalid"
              exit 1
            fi
          fi

          echo "tag=$next_tag" >> "$GITHUB_OUTPUT"
          echo "previous_tag=$previous_tag" >> "$GITHUB_OUTPUT"

  build-linux-windows:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.11
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Validate project
        run: make ci

      - name: Build Linux/Windows release artifacts
        run: |
          make release \
            VERSION=${{ needs.prepare.outputs.tag }} \
            PLATFORMS="linux/amd64 linux/arm64 windows/amd64 windows/arm64"

      - name: Upload Linux/Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-linux-windows
          path: |
            dist/*.tar.gz
            dist/*.zip

  build-darwin:
    needs: prepare
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.11
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Validate project
        run: make ci

      - name: Build Darwin release artifact
        run: |
          host_goarch="$(go env GOARCH)"
          make release \
            VERSION=${{ needs.prepare.outputs.tag }} \
            PLATFORMS="darwin/${host_goarch}"

      - name: Upload Darwin artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-darwin
          path: |
            dist/*.tar.gz
            dist/*.zip

  build-ghcr:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Compute image name
        id: image
        run: |
          owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          echo "name=ghcr.io/${owner}/lopper" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push release image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.image.outputs.name }}:${{ needs.prepare.outputs.tag }}
            ${{ steps.image.outputs.name }}:latest
          provenance: false
          sbom: true

  publish:
    needs:
      - prepare
      - build-linux-windows
      - build-darwin
      - build-ghcr
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout (for changelog generation)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: release-*
          merge-multiple: true
          path: dist

      - name: Generate changelog
        run: |
          set -euo pipefail
          current_tag="${{ needs.prepare.outputs.tag }}"
          previous_tag="${{ needs.prepare.outputs.previous_tag }}"
          ghcr_owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          ghcr_ref="ghcr.io/${ghcr_owner}/lopper:${current_tag}"
          ghcr_package_url="https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lopper"

          {
            echo "## Weekly semver release"
            echo
            echo "- Tag: \`${current_tag}\`"
            echo "- Trigger: scheduled Saturday release"
            echo
            echo "## Container image"
            echo
            echo "- Tagged image: \`${ghcr_ref}\`"
            echo "- Package: [GHCR lopper package](${ghcr_package_url})"
            echo "- Pull command: \`docker pull ${ghcr_ref}\`"
            echo
            if [ -n "${previous_tag}" ]; then
              echo "Changes since \`${previous_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${previous_tag}..${GITHUB_SHA}"
            else
              echo "All commits up to \`${current_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${GITHUB_SHA}"
            fi
            echo
            echo
            echo "---"
            echo
            echo "_GitHub auto-generated release notes follow._"
          } > release-changelog.md

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Release ${{ needs.prepare.outputs.tag }}
          body_path: release-changelog.md
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip

  update-homebrew-tap:
    needs:
      - prepare
      - publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Detect tap token
        id: tap_token
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -n "${HOMEBREW_TAP_TOKEN}" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Homebrew
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        uses: Homebrew/actions/setup-homebrew@04a6d8cfe9d251e2afb78c5bdc6274ec9642aea2

      - name: Checkout tap repository
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        uses: actions/checkout@v6
        with:
          repository: ben-ranford/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update lopper formula
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.tag }}
          SOURCE_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          source_url="https://github.com/${SOURCE_REPO}/archive/refs/tags/${RELEASE_TAG}.tar.gz"
          curl --fail --show-error --silent --location \
            --retry 5 --retry-all-errors --retry-delay 2 \
            --connect-timeout 20 --max-time 180 \
            "$source_url" -o /tmp/lopper-source.tar.gz
          source_sha="$(sha256sum /tmp/lopper-source.tar.gz | awk '{print $1}')"

          mkdir -p Formula
          cat > Formula/lopper.rb <<RUBY
          class Lopper < Formula
            desc "Local-first CLI/TUI for measuring dependency surface area"
            homepage "https://github.com/ben-ranford/lopper"
            url "${source_url}"
            sha256 "${source_sha}"
            license "MIT"

            depends_on "go" => :build
            conflicts_with "lopper-rolling", because: "both install the lopper executable"

            def install
              system "go", "build", *std_go_args(output: bin/"lopper"), "./cmd/lopper"
            end

            test do
              assert_match "Usage:", shell_output("#{bin}/lopper --help")
            end
          end
          RUBY

      - name: Validate formula
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        run: |
          set -euo pipefail
          brew untap ben-ranford/tap >/dev/null 2>&1 || true
          brew tap --custom-remote ben-ranford/tap "file://${PWD}"
          brew audit --strict --online ben-ranford/tap/lopper
          brew install --build-from-source ben-ranford/tap/lopper
          brew test ben-ranford/tap/lopper

      - name: Commit and push formula changes
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Formula/lopper.rb
          if git diff --cached --quiet; then
            echo "No formula changes to commit"
            exit 0
          fi

          git commit -m "lopper ${{ needs.prepare.outputs.tag }}"
          git push origin HEAD:main

      - name: Skip tap update when token is missing
        if: ${{ steps.tap_token.outputs.available != 'true' }}
        run: echo "HOMEBREW_TAP_TOKEN not configured; skipping tap update."
