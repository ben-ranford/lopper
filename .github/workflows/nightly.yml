name: nightly

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '.github/**'
      - 'README.md'
      - 'CONTRIBUTING.md'

concurrency:
  group: release-nightly-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  publish-nightly:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute nightly tag
        id: nightly
        run: |
          short_sha="${GITHUB_SHA::7}"
          date_tag="$(date -u +'%Y%m%d%H%M%S')"
          tag="nightly-${date_tag}-${short_sha}"
          bundle="lopper_${tag}_source"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "bundle=$bundle" >> "$GITHUB_OUTPUT"

      - name: Build nightly source bundle
        run: |
          set -euo pipefail
          mkdir -p dist
          bundle="${{ steps.nightly.outputs.bundle }}"
          archive_path="dist/${bundle}.tar.gz"

          git archive --format=tar.gz --prefix="${bundle}/" -o "$archive_path" "$GITHUB_SHA"
          sha256sum "$archive_path" > "${archive_path}.sha256"

      - name: Generate nightly release notes
        run: |
          set -euo pipefail
          current_tag="${{ steps.nightly.outputs.tag }}"
          previous_tag="$(git tag --list 'nightly-*' --sort=-creatordate | head -n1)"

          {
            echo "## Nightly build from main"
            echo
            echo "This is a nightly pre-release generated from the latest \`main\` commit."
            echo
            echo "- Tag: \`${current_tag}\`"
            echo "- Stability: nightly (not a stable semver release)"
            echo "- Use this for early validation; prefer semver releases for Homebrew tap updates."
            echo
            if [ -n "${previous_tag}" ]; then
              echo "Changes since \`${previous_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${previous_tag}..${GITHUB_SHA}"
            else
              echo "Commits in this nightly:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${GITHUB_SHA}"
            fi
          } > nightly-changelog.md

      - name: Publish nightly prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.nightly.outputs.tag }}
          name: Nightly ${{ steps.nightly.outputs.tag }}
          body_path: nightly-changelog.md
          prerelease: true
          files: |
            dist/*.tar.gz
            dist/*.sha256
