name: rolling

on:
  pull_request:
    types:
      - closed
    branches:
      - main

concurrency:
  group: release-rolling-main
  cancel-in-progress: false

jobs:
  prepare-rolling:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.rolling.outputs.tag }}
      source_sha: ${{ steps.rolling.outputs.source_sha }}
    steps:
      - name: Compute rolling tag
        id: rolling
        run: |
          source_sha="${{ github.event.pull_request.merge_commit_sha || github.sha }}"
          short_sha="${source_sha::7}"
          date_tag="$(date -u +'%Y%m%d%H%M%S')"
          tag="rolling-${date_tag}-${short_sha}"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "source_sha=${source_sha}" >> "$GITHUB_OUTPUT"

  build-rolling-linux-windows:
    needs:
      - prepare-rolling
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare-rolling.outputs.source_sha }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.11
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Validate project
        run: make ci

      - name: Build rolling Linux/Windows artifacts
        run: |
          make release \
            VERSION=${{ needs.prepare-rolling.outputs.tag }} \
            PLATFORMS="linux/amd64 linux/arm64 windows/amd64 windows/arm64"

      - name: Upload rolling Linux/Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: rolling-linux-windows
          path: |
            dist/*.tar.gz
            dist/*.zip

  build-rolling-darwin:
    needs:
      - prepare-rolling
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare-rolling.outputs.source_sha }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install tooling
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.9.0
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.11
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Validate project
        run: make ci

      - name: Build rolling Darwin artifact
        run: |
          host_goarch="$(go env GOARCH)"
          make release \
            VERSION=${{ needs.prepare-rolling.outputs.tag }} \
            PLATFORMS="darwin/${host_goarch}"

      - name: Upload rolling Darwin artifacts
        uses: actions/upload-artifact@v6
        with:
          name: rolling-darwin
          path: |
            dist/*.tar.gz
            dist/*.zip

  publish-rolling:
    needs:
      - prepare-rolling
      - build-rolling-linux-windows
      - build-rolling-darwin
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      tag: ${{ needs.prepare-rolling.outputs.tag }}
    env:
      ROLLING_TAG: ${{ needs.prepare-rolling.outputs.tag }}
      SOURCE_SHA: ${{ needs.prepare-rolling.outputs.source_sha }}
    steps:
      - name: Checkout (for changelog generation)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ env.SOURCE_SHA }}

      - name: Download rolling binary artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: rolling-*
          merge-multiple: true
          path: dist

      - name: Build rolling source bundle
        run: |
          set -euo pipefail
          mkdir -p dist
          bundle="lopper_${ROLLING_TAG}_source"
          archive_path="dist/${bundle}.tar.gz"

          git archive --format=tar.gz --prefix="${bundle}/" -o "$archive_path" "$SOURCE_SHA"
          sha256sum "$archive_path" > "${archive_path}.sha256"

      - name: Generate rolling release notes
        run: |
          set -euo pipefail
          git fetch --tags --force
          previous_tag=""
          while IFS= read -r candidate; do
            if [ "${candidate}" != "${ROLLING_TAG}" ]; then
              previous_tag="${candidate}"
              break
            fi
          done < <(git tag --list 'rolling-*' --sort=-creatordate)

          {
            echo "## Rolling build from main"
            echo
            echo "This is a rolling pre-release generated from the latest merged \`main\` commit."
            echo
            echo "- Tag: \`${ROLLING_TAG}\`"
            echo "- Stability: rolling (not a stable semver release)"
            echo "- Docker rolling tag: \`ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/lopper:rolling\`"
            echo "- Homebrew rolling formula: \`ben-ranford/tap/lopper-rolling\`"
            echo
            if [ -n "${previous_tag}" ]; then
              echo "Changes since \`${previous_tag}\`:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${previous_tag}..${SOURCE_SHA}"
            else
              echo "Commits in this rolling build:"
              echo
              git log --reverse --pretty=format:'- %h %s (%an)' "${SOURCE_SHA}"
            fi
          } > rolling-changelog.md

      - name: Compute image name
        id: image
        run: |
          owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          echo "name=ghcr.io/${owner}/lopper" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push rolling image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.image.outputs.name }}:${{ env.ROLLING_TAG }}
            ${{ steps.image.outputs.name }}:rolling
          provenance: false
          sbom: true

      - name: Publish rolling prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.ROLLING_TAG }}
          target_commitish: ${{ env.SOURCE_SHA }}
          name: Rolling ${{ env.ROLLING_TAG }}
          body_path: rolling-changelog.md
          prerelease: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.sha256

  update-homebrew-tap-rolling:
    needs:
      - prepare-rolling
      - publish-rolling
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Detect tap token
        id: tap_token
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -n "${HOMEBREW_TAP_TOKEN}" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Homebrew
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        uses: Homebrew/actions/setup-homebrew@04a6d8cfe9d251e2afb78c5bdc6274ec9642aea2

      - name: Checkout tap repository
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        uses: actions/checkout@v6
        with:
          repository: ben-ranford/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update lopper-rolling formula
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        env:
          ROLLING_TAG: ${{ needs.prepare-rolling.outputs.tag }}
          SOURCE_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          source_url="https://github.com/${SOURCE_REPO}/archive/refs/tags/${ROLLING_TAG}.tar.gz"
          curl --fail --show-error --silent --location \
            --retry 5 --retry-all-errors --retry-delay 2 \
            --connect-timeout 20 --max-time 180 \
            "$source_url" -o /tmp/lopper-rolling-source.tar.gz
          source_sha="$(sha256sum /tmp/lopper-rolling-source.tar.gz | awk '{print $1}')"

          mkdir -p Formula
          cat > Formula/lopper-rolling.rb <<RUBY
          class LopperRolling < Formula
            desc "Local-first CLI/TUI for measuring dependency surface area"
            homepage "https://github.com/ben-ranford/lopper"
            url "${source_url}"
            sha256 "${source_sha}"
            license "MIT"

            depends_on "go" => :build
            keg_only :versioned_formula

            def install
              system "go", "build", *std_go_args(output: bin/"lopper"), "./cmd/lopper"
            end

            test do
              assert_match "Usage:", shell_output("#{bin}/lopper --help")
            end
          end
          RUBY

      - name: Validate rolling formula
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        run: |
          set -euo pipefail
          brew untap ben-ranford/tap >/dev/null 2>&1 || true
          brew tap --custom-remote ben-ranford/tap "file://${PWD}"
          brew audit --strict --online ben-ranford/tap/lopper-rolling
          brew install --build-from-source ben-ranford/tap/lopper-rolling
          brew test ben-ranford/tap/lopper-rolling

      - name: Commit and push rolling formula changes
        if: ${{ steps.tap_token.outputs.available == 'true' }}
        working-directory: homebrew-tap
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Formula/lopper-rolling.rb
          if git diff --cached --quiet; then
            echo "No rolling formula changes to commit"
            exit 0
          fi

          git commit -m "lopper-rolling ${{ needs.prepare-rolling.outputs.tag }}"
          git push origin HEAD:main

      - name: Skip rolling tap update when token is missing
        if: ${{ steps.tap_token.outputs.available != 'true' }}
        run: echo "HOMEBREW_TAP_TOKEN not configured; skipping rolling tap update."
